<div class="messages_component">

  <!--since virtual scroll doesn't work with items of variable height, load everything-->

  <cdk-virtual-scroll-viewport (scrolledIndexChange)="OnMessagesScrolled($event)"
                               minBufferPx="120000"
                               maxBufferPx="250000"
                               itemSize="50"
                               class="messages_main">

    <div *cdkVirtualFor="let message of Conversation.messages;">

      <div (click)="SelectMessage(message)">

        <!--loading progress spinner-->

        <div *ngIf="MessagesLoading && IsLastMessage(message)" class="padding10px">
          <mat-progress-spinner class="load-spinner"
                                diameter="60"
                                color="Primary"
                                mode="indeterminate">
          </mat-progress-spinner>
        </div>

        <!--Today, yesterday . .etc-->

        <div *ngIf="IsPreviousMessageOnAnotherDay(message)" class="messages_datestrip_wrapper padding10px">
          <span class="datestrip_text">{{formatter.GetMessagesDateStripFormatted(message)}}</span>
        </div>

        <div class="messages_message_content" [ngClass]="{'selected-message': IsMessageSelected(message)}">

          <!--name and avatar-->

          <div style="width: 35px; height: 35px; margin-right: 15px; cursor:pointer" (click)="ViewUserInfo($event, message.user)">
            <img *ngIf="IsFirstMessageInSequence(message) || (message.forwardedMessage)" class="rounded-chat-image" src="{{message.user.imageUrl}}" />
          </div>

          <div class="content_messageAndName">
            <span *ngIf="IsFirstMessageInSequence(message) || (message.forwardedMessage)" class="message_header">{{message.user.userName}}</span>

            <p *ngIf="! message.isAttachment" class="message_text">{{message.messageContent}}</p>

            <!--Attachments-->

            <div *ngIf="IsImage(message)" class="image_attachment">
              <img class="message_attachment--image" [style.width.px]="message.attachmentInfo.imageWidth" [style.height.px]="message.attachmentInfo.imageHeight" src="{{message.attachmentInfo.contentUrl}}" />
            </div>

            <!--Audio / archive / etc-->
            <!--Forwarded message-->
            <div *ngIf="message.forwardedMessage" class="forwarded_message">

              <div>

                <div class="messages_message_content" [ngClass]="{'selected-message': IsMessageSelected(message)}">

                  <div style="width: 35px; height: 35px; margin-right: 15px; cursor:pointer" (click)="ViewUserInfo($event, message.forwardedMessage.user)">
                    <img class="rounded-chat-image" src="{{message.forwardedMessage.user.imageUrl}}" />
                  </div>

                  <div class="content_messageAndName">
                    <span class="message_header">{{message.forwardedMessage.user.userName}}</span>

                    <p *ngIf="! message.forwardedMessage.isAttachment" class="message_text">{{message.forwardedMessage.messageContent}}</p>

                    <!--Attachments-->

                    <div *ngIf="IsImage(message.forwardedMessage)" class="image_attachment">
                      <img class="message_attachment--image"
                           [style.width.px]="message.forwardedMessage.attachmentInfo.imageWidth"
                           [style.height.px]="message.forwardedMessage.attachmentInfo.imageHeight"
                           src="{{message.forwardedMessage.attachmentInfo.contentUrl}}" />
                    </div>

                    <!--Audio / archive / etc-->

                  </div>

                  <span class="message_timereceived">{{formatter.GetMessageTimeFormatted(message.forwardedMessage)}}</span>
                </div>
              </div>

            </div>
            <!--Forwarded message end-->
          </div>

          <div class="time-and-states-wrapper">

            <span class="message_timereceived">{{formatter.GetMessageTimeFormatted(message)}}</span>
            <!--read, delivered etc.-->

            <mat-icon class="messagestate" *ngIf="message.state == 0">
              query_builder
            </mat-icon>

            <mat-icon class="messagestate" *ngIf="message.state == 1">
              done
            </mat-icon>

            <mat-icon class="messagestate" *ngIf="message.state == 2">
              done_all
            </mat-icon>

          </div>
        </div>

      </div>

    </div>
  </cdk-virtual-scroll-viewport>

  <div class="chat_misc">
    <div (click)="ScrollToStart()" class="chat_misc_backtonow" *ngIf="IsScrollingAssistNeeded" [@slideIn]>
      <mat-icon>keyboard_arrow_down</mat-icon>
      <span>Back to now</span>
    </div>

    <button mat-button
            color="primary"
            class="marginleft10px"
            *ngIf="SelectedMessages.length !== 0"
            (click)="DeleteMessages()"
            [@slideIn]>
      Delete messages
    </button>

    <button mat-button
            color="primary"
            *ngIf="SelectedMessages.length !== 0"
            (click)="ForwardMessages()"
            [@slideIn]>
      Forward messages
    </button>
  </div>

</div>

<style>
  .chat_misc_backtonow{
    display: flex;
    flex-direction:row;
    margin-left: 43%;
    justify-content: center;
    align-items: center;
    box-shadow: 0 1px 3px 0 rgba(0,0,0,.1);
    border-radius: 10px;
    border: solid 1px #cfd9e1;
    padding: 4px 4px 4px 4px;
    color: cadetblue;
    height: 20px;
    transition: all 0.3s ease 0s;
    cursor:pointer;
  }
  .chat_misc_backtonow:hover{
    transition: all 0.3s ease 0s;
    background-color: #f0f6f6;
  }

  .time-and-states-wrapper{
    display: flex;
    flex-direction: column;
  }
  .messagestate{
    color:cadetblue;
    width: 15px;
    height: 15px;
  }
  .forwarded_message{
    border-left: 2px solid cadetblue;
  }
</style>
